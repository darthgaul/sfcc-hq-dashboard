<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFCC Operations Dashboard</title>
    <!-- Load Tailwind CSS via CDN for single-file deployment -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        :root {
            --purple-500: #a855f7;
            --purple-600: #9333ea;
        }
        body {
            font-family: 'Inter', sans-serif;
            transition: all 0.3s ease-out;
        }
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--purple-500);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .promotion-timeline {
            position: relative;
            border-left: 2px solid #374151; /* gray-700 */
            margin-left: 8px;
            padding-left: 1rem;
        }
        .timeline-item {
            position: relative;
            margin-bottom: 1rem;
        }
        .timeline-item-dot {
            position: absolute;
            left: -19px; /* Adjust to center dot over line */
            top: 4px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            border: 2px solid #000; /* For contrast */
        }

        /* --- Mobile Menu Fix: Ensure sidebar is visible when opened --- */
        @media (max-width: 1023px) { /* Up to lg breakpoint */
            /* This overrides the default -translate-x-full when mobileMenuOpen is true */
            #sidebar[data-menu-state="open"] {
                transform: translateX(0);
            }
        }
    </style>
    <script type="module">
        // Import Lucide icons dynamically to use in the HTML
        // NOTE: These imports provide functions that return SVG markup when called.
        import { Shield, Users, FileText, AlertTriangle, CheckCircle, BarChart3, Calendar, Lock, ChevronRight, Menu, X, UserCheck, Flag, LayoutDashboard, Award, Clock, ChevronUp } from 'https://unpkg.com/lucide@latest/dist/esm/lucide.js';

        // Map component names to actual functions/classes (required for dynamic icons)
        const Icons = { Shield, Users, FileText, AlertTriangle, CheckCircle, BarChart3, Calendar, Lock, ChevronRight, Menu, X, UserCheck, Flag, LayoutDashboard, Award, Clock, ChevronUp };

        // --- MOCK DATA ---
        const USERS = [
            { id: 'u1', name: 'Gen. A. Smith', role: 'HQ', title: 'Chief of Operations' },
            { id: 'u2', name: 'Col. B. Miller', role: 'Regional', region: 'North-East' },
            { id: 'u3', name: 'Maj. C. Davis', role: 'Squadron', unit: 'SQ-101' },
            { id: 'u4', name: 'Cdt. E. Ender', role: 'Cadet', unit: 'SQ-101', grade: 'C/SSgt' },
            { id: 'u5', name: 'Mrs. Ender', role: 'Parent', cadetId: 'u4' },
        ];

        let artifacts = [
            { id: 101, cadetName: 'Cdt. E. Ender', loe: 'STEM', title: 'Rocketry Lab Report', score: 3, status: 'Approved', safetyCheck: true, boardReady: true, date: '2023-10-01' },
            { id: 102, cadetName: 'Cdt. E. Ender', loe: 'Leadership', title: 'Squadron Drill Cmd', score: 1, status: 'Returned', safetyCheck: true, boardReady: false, date: '2023-10-05' }, // Remediation item
            { id: 103, cadetName: 'Cdt. J. Doe', loe: 'Fitness', title: '1 Mile Run Log', score: 0, status: 'Submitted', safetyCheck: false, boardReady: false, date: '2023-10-10' }, // Pending Review
            { id: 104, cadetName: 'Cdt. E. Ender', loe: 'Service', title: 'Community Cleanup', score: 4, status: 'Approved', safetyCheck: true, boardReady: true, date: '2023-09-15' },
            { id: 105, cadetName: 'Cdt. A. Smith', loe: 'STEM', title: 'Cyber Security Basics', score: 2, status: 'Submitted', safetyCheck: true, boardReady: false, date: '2023-10-12' },
        ];

        const EVENTS = [
            { id: 1, title: 'Regional FTX (MTE)', date: '2023-11-10', type: 'MTE', recovery: true },
            { id: 2, title: 'Squadron Meeting', date: '2023-11-15', type: 'Regular', recovery: false },
            { id: 3, title: 'Annual Inspection', date: '2023-12-01', type: 'MTE', recovery: true },
        ];

        const cadetProfile = {
            joinDate: 'Aug 15, 2022',
            promotions: [
                { rank: 'C/SSgt', name: 'Staff Sergeant', date: 'Oct 01, 2023', active: true },
                { rank: 'C/SrA', name: 'Senior Airman', date: 'Feb 15, 2023' },
                { rank: 'C/Amn', name: 'Airman', date: 'Sep 01, 2022' }
            ],
            awards: [
                { name: 'Honor Flight Ribbon', earned: true, date: '2023-06-10', color: 'bg-yellow-500', type: 'Service' },
                { name: 'Physical Excellence', earned: true, date: '2022-12-10', color: 'bg-green-600', type: 'Fitness' },
                { name: 'Leadership Basics', earned: true, date: '2022-09-30', color: 'bg-blue-600', type: 'Leadership' },
                { name: 'Cyber CyberBadge', earned: false, progress: 80, color: 'bg-indigo-500', type: 'STEM' },
                { name: 'Community Service', earned: false, progress: 45, color: 'bg-red-500', type: 'Service' }
            ]
        };

        // --- STATE & UTILS ---
        let currentUser = USERS[0]; // Initial state
        let selectedArtifact = null;
        let mobileMenuOpen = false;

        /** * Utility to create an HTML element with classes, content, and optional mutation callback (mutator).
         * @param {string} tag - The HTML tag name (e.g., 'div').
         * @param {string} classes - Tailwind classes.
         * @param {string | Node | Node[]} [content=''] - The content (string, single Node, or array of Nodes).
         * @param {function(Node): void} [mutator=null] - An optional function to apply mutations (like attributes) to the created element.
         */
        const h = (tag, classes, content = '', mutator = null) => {
            const el = document.createElement(tag);
            if (classes) el.className = classes;

            if (content) {
                if (typeof content === 'string') {
                    el.innerHTML = content;
                } else if (Array.isArray(content)) {
                    // FIX: Only append actual DOM Node objects from the array to prevent TypeError: parameter 1 is not of type 'Node'.
                    content.filter(c => c instanceof Node).forEach(c => el.appendChild(c));
                } else if (content instanceof Node) {
                    el.appendChild(content);
                }
            }
            
            // Apply mutator if provided (now correctly supported as the fourth argument)
            if (typeof mutator === 'function') {
                mutator(el);
            }

            return el;
        };

        /** Renders a Lucide icon as an SVG element (FIXED) */
        const renderIcon = (Icon, size = 20, classes = 'mr-2') => {
            const container = document.createElement('div');
            container.className = classes;
            container.style.width = `${size}px`;
            container.style.height = `${size}px`;
            
            let svgMarkup = '';

            // CRITICAL FIX: Ensure the Icon is a function before calling it, otherwise fall back to empty/placeholder
            if (typeof Icon === 'function') {
                // Call the Icon function directly, passing props
                svgMarkup = Icon({ class: 'w-full h-full' });
            } else {
                console.warn("Lucide Icon variable is not a function:", Icon);
                // Fallback icon (X) to prevent crash
                svgMarkup = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M15 9l-6 6M9 9l6 6"/></svg>';
            }
            
            container.innerHTML = svgMarkup;
            return container;
        };

        const renderBadge = (status, score) => {
            let color = 'bg-gray-600 text-gray-200';
            if (status === 'Approved') color = 'bg-green-900/50 text-green-200 border border-green-700';
            if (status === 'Returned' || (score !== null && score < 2)) color = 'bg-red-900/50 text-red-200 border border-red-700';
            if (status === 'Submitted') color = 'bg-yellow-900/50 text-yellow-200 border border-yellow-700';

            return h('span', `px-2 py-1 rounded text-xs font-mono uppercase tracking-wider ${color}`, status);
        };

        const renderCard = (content, classes = '') => {
            return h('div', `bg-gray-800 border border-gray-700 rounded-lg shadow-lg p-5 ${classes}`, content);
        };

        const renderStatCard = (title, value, subtext, Icon, alert = false) => {
            const iconDiv = h('div', `p-3 rounded-full ${alert ? 'bg-red-900/50 text-red-400' : 'bg-purple-900/50 text-purple-400'}`, renderIcon(Icon, 24, ''));
            const contentDiv = h('div', '', [
                h('h3', 'text-gray-400 text-sm uppercase tracking-wider font-semibold', title),
                h('div', 'text-2xl font-bold text-white font-mono', value),
                subtext ? h('div', 'text-xs text-gray-500 mt-1', subtext) : null
            ].filter(Boolean));

            return renderCard([iconDiv, contentDiv], 'flex items-center space-x-4');
        };

        // --- VIEWS ---

        const renderHQView = () => {
            // ... (HQView logic here, using h() for HTML elements) ...
            const remediationRate = Math.round((artifacts.filter(a => a.score < 2 && a.score > 0).length / artifacts.length) * 100);

            const content = h('div', 'space-y-6 animate-fade-in', [
                h('div', 'grid grid-cols-1 md:grid-cols-4 gap-4', [
                    renderStatCard("Total Cadets", "1,240", "+12% YoY Growth", Icons.Users),
                    renderStatCard("Compliance Rate", "94%", "Q3 Reports Submitted", Icons.Shield),
                    renderStatCard("Remediation Rate", `${remediationRate}%`, "Artifacts Scoring < 2", Icons.AlertTriangle, remediationRate > 15),
                    renderStatCard("Waiver Logs", "3", "Pending Approval", Icons.FileText),
                ]),
                // ... (Heatmap and Risk Log - simplified) ...
                h('div', 'grid grid-cols-1 lg:grid-cols-2 gap-6', [
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.BarChart3, 20),
                            h('span', '', 'National Compliance Heatmap')
                        ]),
                        // Simplified Heatmap
                        h('div', 'space-y-3', ['North-East (92%)', 'South-East (88%)', 'Central (65%)', 'West-Coast (95%)'].map((text, idx) => {
                            const [region, percent] = text.split(' ');
                            const width = percent.slice(1, -2);
                            const color = idx === 2 ? 'bg-red-500' : 'bg-purple-500';
                            return h('div', 'flex items-center justify-between', [
                                h('span', 'text-gray-300 w-24', region),
                                h('div', 'flex-1 mx-4 h-2 bg-gray-700 rounded-full overflow-hidden', [
                                    // Mutator used as the 4th argument (now correctly supported)
                                    h('div', `h-full ${color}`, '', el => el.style.width = width + '%')
                                ]),
                                h('span', 'text-gray-400 font-mono text-sm', percent)
                            ]);
                        }))
                    ]),
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.AlertTriangle, 20),
                            h('span', '', 'Critical Risk / Waiver Log')
                        ]),
                        h('table', 'w-full text-left text-sm', [
                            h('thead', '', h('tr', 'text-gray-500 border-b border-gray-700', [
                                h('th', 'pb-2', 'Unit'), h('th', 'pb-2', 'Issue'), h('th', 'pb-2', 'Risk Level')
                            ])),
                            h('tbody', 'text-gray-300', [
                                h('tr', 'border-b border-gray-800', [h('td', 'py-2', 'SQ-404'), h('td', '', 'Missing Youth Protection Certs'), h('td', 'text-red-400', 'HIGH')]),
                                h('tr', 'border-b border-gray-800', [h('td', 'py-2', 'SQ-102'), h('td', '', 'Safety Ratio Waiver Request'), h('td', 'text-yellow-400', 'MED')])
                            ])
                        ])
                    ])
                ])
            ]);
            return content;
        };
        
        // Function to render the Cadet View (focus of the request)
        const renderCadetView = () => {
            const myArtifacts = artifacts.filter(a => a.cadetName === 'Cdt. E. Ender');
            const remediationItems = myArtifacts.filter(a => a.score !== null && a.score < 2);
            const currentRank = cadetProfile.promotions.find(p => p.active);

            // 1. Personnel Header (Photo, Rank, Promotions, Awards)
            const promotionLog = h('div', 'promotion-timeline', cadetProfile.promotions.map(p => {
                const dotClasses = p.active ? 'bg-purple-500 shadow-[0_0_8px_rgba(168,85,247,0.5)]' : 'bg-gray-600';
                return h('div', 'timeline-item', [
                    h('div', `timeline-item-dot ${dotClasses}`),
                    h('div', 'flex justify-between items-center', [
                        h('span', `font-mono font-bold ${p.active ? 'text-white' : 'text-gray-500'}`, p.rank),
                        h('span', 'text-xs text-gray-600', p.date)
                    ])
                ]);
            }));

            const awardsRibbons = h('div', '', [
                // Earned Rack
                h('div', 'flex flex-wrap gap-1 mb-4', cadetProfile.awards.filter(a => a.earned).map(award => 
                    // Mutator used as the 4th argument (now correctly supported)
                    h('div', `h-6 w-8 ${award.color} rounded-sm shadow-sm border border-black/20`, '', el => el.title = `${award.name} - Earned ${award.date}`)
                )),
                // Active Pursuits
                h('div', 'space-y-3', cadetProfile.awards.filter(a => !a.earned).map(award => h('div', '', [
                    h('div', 'flex justify-between text-[10px] uppercase tracking-wide mb-1 text-gray-400', [
                        h('span', '', award.name),
                        h('span', '', `${award.progress}%`)
                    ]),
                    h('div', 'h-1.5 w-full bg-gray-800 rounded-full overflow-hidden', [
                        // Mutator used as the 4th argument (now correctly supported)
                        h('div', `h-full ${award.color}`, '', el => el.style.width = `${award.progress}%`)
                    ])
                ])))
            ]);


            const personnelHeader = renderCard([
                h('div', 'flex flex-col md:flex-row gap-6 items-start w-full', [
                    // Photo & Rank Column
                    h('div', 'flex-shrink-0 flex flex-col items-center space-y-3 w-full md:w-auto', [
                        h('div', 'relative', [
                            h('img', 'rounded-lg border-2 border-gray-600 shadow-xl object-cover', '', el => {
                                el.src = "https://placehold.co/150x200/334155/white?text=Cadet+Photo";
                                el.alt = "Cadet";
                            }),
                            h('div', 'absolute -bottom-3 -right-3', h('img', 'rounded-full border-4 border-gray-800 shadow-lg', '', el => {
                                el.src = "https://placehold.co/48x48/4c1d95/white?text=Rk";
                                el.alt = "Rank Insignia";
                            }))
                        ]),
                        h('div', 'text-center', [
                            h('h2', 'text-xl font-bold text-white', currentRank.rank),
                            h('p', 'text-xs text-purple-400 uppercase tracking-widest font-bold', currentRank.name)
                        ])
                    ]),

                    // Bio & Stats Column
                    h('div', 'flex-grow w-full', [
                        h('div', 'flex justify-between items-start mb-6', [
                            h('div', '', [
                                h('h2', 'text-3xl font-bold text-white', 'Cadet E. Ender'),
                                h('div', 'flex items-center text-gray-400 mt-1 space-x-4 text-sm', [
                                    h('span', 'flex items-center', [renderIcon(Icons.Users, 14, 'mr-1'), h('span', '', 'Squadron 101')]),
                                    h('span', 'flex items-center', [renderIcon(Icons.Clock, 14, 'mr-1'), h('span', '', `Joined ${cadetProfile.joinDate}`)])
                                ])
                            ]),
                            h('div', 'hidden md:block text-right', [
                                h('div', 'text-xs text-gray-500 uppercase tracking-wider', 'Next Evaluation'),
                                h('div', 'text-lg font-mono text-white', 'Dec 15, 2023')
                            ])
                        ]),

                        h('div', 'grid grid-cols-1 md:grid-cols-2 gap-4', [
                            // Promotion Log
                            h('div', 'bg-gray-900/50 p-4 rounded border border-gray-700', [
                                h('h4', 'text-xs font-bold text-purple-400 uppercase tracking-wider mb-4 flex items-center', [
                                    renderIcon(Icons.ChevronUp, 14, 'mr-1'),
                                    h('span', '', 'Promotion Log')
                                ]),
                                promotionLog
                            ]),
                            // Awards & Ribbons
                            h('div', 'bg-gray-900/50 p-4 rounded border border-gray-700', [
                                h('h4', 'text-xs font-bold text-purple-400 uppercase tracking-wider mb-4 flex items-center', [
                                    renderIcon(Icons.Award, 14, 'mr-1'),
                                    h('span', '', 'Awards & Pursuits')
                                ]),
                                awardsRibbons
                            ])
                        ])
                    ])
                ])
            ], 'w-full');

            // 2. Warnings
            const remediationWarning = remediationItems.length > 0 ? h('div', 'bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r flex items-start', [
                renderIcon(Icons.AlertTriangle, 20, 'text-red-500 mr-3 mt-1'),
                h('div', '', [
                    h('h4', 'text-red-400 font-bold', 'Action Required: Remediation'),
                    h('p', 'text-red-200 text-sm mt-1', `You have ${remediationItems.length} artifact(s) that scored below the minimum (2/4). Please revise and resubmit per CCR 20-7.`)
                ])
            ]) : null;

            // 3. Progress and Next MTE
            const progressCard = renderCard([
                h('h3', 'text-purple-400 font-bold uppercase text-sm mb-4', 'Promotion Requirements'),
                h('div', 'space-y-6', [
                    h('div', '', [
                        h('div', 'flex justify-between text-sm text-gray-300 mb-2', [h('span', '', 'STEM Requirements'), h('span', 'font-mono', '2/3')]),
                        h('div', 'h-4 bg-gray-700 rounded-full overflow-hidden', h('div', 'h-full bg-purple-500', '', el => el.style.width = '66%'))
                    ]),
                    h('div', '', [
                        h('div', 'flex justify-between text-sm text-gray-300 mb-2', [h('span', '', 'Leadership Logs'), h('span', 'font-mono', '4/5')]),
                        h('div', 'h-4 bg-gray-700 rounded-full overflow-hidden', h('div', 'h-full bg-purple-500', '', el => el.style.width = '80%'))
                    ])
                ])
            ], 'md:col-span-2');

            const nextMTECard = renderCard([
                h('h3', 'text-gray-400 text-sm uppercase mb-2', 'Next Major Event'),
                h('div', 'text-2xl font-bold text-white mb-1', 'Regional FTX'),
                h('div', 'text-purple-400 flex items-center mb-4', [renderIcon(Icons.Calendar, 16, 'mr-2'), h('span', '', 'Nov 10')]),
                h('div', 'bg-green-900/30 text-green-400 px-3 py-2 rounded text-xs border border-green-800 flex items-center', [
                    renderIcon(Icons.CheckCircle, 14, 'mr-2'), h('span', '', 'Recovery Period Confirmed')
                ])
            ], 'bg-gradient-to-br from-gray-800 to-gray-900');

            // 4. Evidence Log
            const evidenceLog = renderCard([
                h('h3', 'text-lg font-bold text-white mb-4', 'My Evidence Portfolio'),
                h('table', 'w-full text-left text-sm text-gray-300', [
                    h('thead', '', h('tr', 'border-b border-gray-700 text-gray-500', [
                        h('th', 'pb-2', 'LOE'), h('th', 'pb-2', 'Title'), h('th', 'pb-2', 'Status'), h('th', 'pb-2 text-right', 'Score')
                    ])),
                    h('tbody', 'divide-y divide-gray-800', myArtifacts.map(a => h('tr', '', [
                        h('td', 'py-3', h('span', 'bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded', a.loe)),
                        h('td', '', a.title),
                        h('td', '', renderBadge(a.status, a.score)),
                        h('td', 'text-right font-mono', a.score > -1 ? a.score : '-')
                    ])))
                ])
            ]);

            return h('div', 'space-y-6 animate-fade-in', [
                personnelHeader,
                remediationWarning,
                h('div', 'grid grid-cols-1 md:grid-cols-3 gap-6', [progressCard, nextMTECard]),
                evidenceLog
            ].filter(Boolean));
        };

        // --- NEW IMPLEMENTATION: Regional View ---
        const renderRegionalView = () => {
            const regionalSquadrons = ['SQ-101', 'SQ-102', 'SQ-205', 'SQ-304'];
            const totalSquadrons = regionalSquadrons.length;
            // Filter artifacts for units in this region (mocking based on simple unit number pattern)
            const regionalArtifacts = artifacts.filter(a => regionalSquadrons.some(unit => a.cadetName.includes(unit.slice(-3)) || a.cadetName === 'Cdt. E. Ender')); 
            const pendingReviews = regionalArtifacts.filter(a => a.status === 'Submitted' || a.status === 'Returned').length;
            const nextMTE = EVENTS.find(e => e.type === 'MTE');
            const regionalCompliance = 88; // Mock value

            // Mock squadron performance data
            const squadronData = regionalSquadrons.map(unit => ({
                unit,
                compliance: unit === 'SQ-102' ? 75 : (Math.random() * 10 + 85).toFixed(0),
                pending: regionalArtifacts.filter(a => a.cadetName.includes(unit.slice(-3)) || (unit === 'SQ-101' && a.cadetName === 'Cdt. E. Ender')).length, // Simple mock link
                risk: unit === 'SQ-102' ? 'High' : 'Low'
            }));

            const content = h('div', 'space-y-6 animate-fade-in', [
                h('div', 'grid grid-cols-1 md:grid-cols-4 gap-4', [
                    renderStatCard("Total Squadrons", totalSquadrons.toString(), "In North-East Region", Icons.Flag),
                    renderStatCard("Regional Compliance", `${regionalCompliance}%`, "Average Artifact Approval", Icons.Shield),
                    renderStatCard("Pending Reviews", pendingReviews.toString(), "Across all units", Icons.FileText),
                    renderStatCard("Next Major Event", nextMTE.date, nextMTE.title, Icons.Calendar, true),
                ]),
                h('div', 'grid grid-cols-1 lg:grid-cols-3 gap-6', [
                    // Squadron Performance Table (2/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.LayoutDashboard, 20),
                            h('span', '', 'Squadron Performance Overview')
                        ]),
                        h('table', 'w-full text-left text-sm', [
                            h('thead', '', h('tr', 'text-gray-500 border-b border-gray-700', [
                                h('th', 'pb-2', 'Unit'), h('th', 'pb-2', 'Compliance %'), h('th', 'pb-2', 'Artifacts'), h('th', 'pb-2 text-right', 'Risk')
                            ])),
                            h('tbody', 'text-gray-300 divide-y divide-gray-800', squadronData.map(d => h('tr', '', [
                                h('td', 'py-3 font-mono', d.unit),
                                h('td', '', h('span', d.risk === 'High' ? 'text-red-400' : 'text-green-400', `${d.compliance}%`)),
                                h('td', '', d.pending.toString()),
                                h('td', 'text-right', h('span', d.risk === 'High' ? 'text-red-400' : 'text-green-400', d.risk))
                            ])))
                        ])
                    ], 'lg:col-span-2'),

                    // Event Calendar (1/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.Calendar, 20),
                            h('span', '', 'Regional Event Schedule')
                        ]),
                        h('div', 'space-y-4', EVENTS.map(e => h('div', 'border-l-2 border-gray-700 pl-3', [
                            h('div', 'text-xs text-gray-500 uppercase tracking-wider', e.type),
                            h('div', 'text-sm font-medium text-white', e.title),
                            h('div', 'text-xs text-purple-400', e.date)
                        ])))
                    ], 'bg-gradient-to-br from-gray-800 to-gray-900')
                ])
            ]);
            return content;
        };

        // --- NEW IMPLEMENTATION: Squadron View ---
        const renderSquadronView = () => {
            const squadronUnit = currentUser.unit; // 'SQ-101'
            // Mocking two cadets belong to SQ-101 for demo purposes
            const squadronCadets = USERS.filter(u => u.role === 'Cadet' && (u.unit === squadronUnit || u.name === 'Cdt. E. Ender')); 
            const totalCadets = squadronCadets.length;
            
            // Filter artifacts relevant to this squadron's review
            const artifactsForReview = artifacts.filter(a => 
                a.cadetName.includes('Cdt. E. Ender') || a.cadetName.includes('Cdt. J. Doe') || a.cadetName.includes('Cdt. A. Smith')
            ).filter(a => a.status === 'Submitted' || a.status === 'Returned');

            const pendingCount = artifactsForReview.filter(a => a.status === 'Submitted').length;
            const remediationCount = artifactsForReview.filter(a => a.status === 'Returned').length;
            const reviewQueueTitle = `Artifact Review Queue (${pendingCount} New)`;

            const content = h('div', 'space-y-6 animate-fade-in', [
                h('div', 'grid grid-cols-1 md:grid-cols-4 gap-4', [
                    renderStatCard("Total Cadets", totalCadets.toString(), `Active in ${squadronUnit}`, Icons.Users),
                    renderStatCard("New Submissions", pendingCount.toString(), "Awaiting review", Icons.FileText),
                    renderStatCard("Remediation Items", remediationCount.toString(), "Needs re-submission", Icons.AlertTriangle, remediationCount > 0),
                    renderStatCard("Board Ready Cadets", '1/2', "Eligible for next promotion", Icons.Award),
                ]),

                h('div', 'grid grid-cols-1 lg:grid-cols-3 gap-6', [
                    // Artifact Review Queue (2/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.FileText, 20),
                            h('span', '', reviewQueueTitle)
                        ]),
                        h('table', 'w-full text-left text-sm', [
                            h('thead', '', h('tr', 'text-gray-500 border-b border-gray-700', [
                                h('th', 'pb-2', 'Cadet'), h('th', 'pb-2', 'Artifact'), h('th', 'pb-2', 'Date'), h('th', 'pb-2 text-center', 'Status')
                            ])),
                            h('tbody', 'text-gray-300 divide-y divide-gray-800', artifactsForReview.map(a => h('tr', '', [
                                h('td', 'py-3', a.cadetName),
                                h('td', '', a.title),
                                h('td', '', a.date.slice(5)), // Month/Day
                                h('td', 'text-center', renderBadge(a.status, a.score))
                            ])))
                        ])
                    ], 'lg:col-span-2'),

                    // Quick Actions (1/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4', 'Quick Actions'),
                        h('div', 'space-y-3', [
                            h('button', 'w-full text-left p-3 rounded-lg bg-gray-700/50 hover:bg-purple-900/50 text-white flex items-center', [
                                renderIcon(Icons.UserCheck, 18), 'Update Roster Status'
                            ]),
                            h('button', 'w-full text-left p-3 rounded-lg bg-gray-700/50 hover:bg-purple-900/50 text-white flex items-center', [
                                renderIcon(Icons.Award, 18), 'Recommend Promotion Board'
                            ]),
                            h('button', 'w-full text-left p-3 rounded-lg bg-gray-700/50 hover:bg-purple-900/50 text-white flex items-center', [
                                renderIcon(Icons.Calendar, 18), 'Log Event Attendance'
                            ]),
                        ])
                    ])
                ])
            ]);
            return content;
        };

        // --- NEW IMPLEMENTATION: Parent View ---
        const renderParentView = () => {
            const cadet = USERS.find(u => u.id === currentUser.cadetId);
            if (!cadet) return h('div', 'bg-red-900/20 border-l-4 border-red-500 p-4 rounded-r text-red-400 font-bold', 'Cadet profile not linked. Please contact Squadron Administration.');

            const myArtifacts = artifacts.filter(a => a.cadetName === cadet.name);
            const approvedCount = myArtifacts.filter(a => a.status === 'Approved').length;
            const remediationItems = myArtifacts.filter(a => a.score !== null && a.score < 2);
            const currentRank = cadetProfile.promotions.find(p => p.active);

            const content = h('div', 'space-y-6 animate-fade-in', [
                h('div', 'grid grid-cols-1 md:grid-cols-3 gap-4', [
                    renderStatCard("Cadet Rank", currentRank.rank, currentRank.name, Icons.Award),
                    renderStatCard("Approved Artifacts", approvedCount.toString(), "Total evidence submitted", Icons.CheckCircle),
                    renderStatCard("Pending Action", remediationItems.length.toString(), "Remediation or Review needed", Icons.AlertTriangle, remediationItems.length > 0),
                ]),

                h('div', 'grid grid-cols-1 lg:grid-cols-3 gap-6', [
                    // Evidence Log (2/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4 flex items-center', [
                            renderIcon(Icons.FileText, 20),
                            h('span', '', `${cadet.name}'s Progress Log`)
                        ]),
                        h('table', 'w-full text-left text-sm', [
                            h('thead', '', h('tr', 'border-b border-gray-700 text-gray-500', [
                                h('th', 'pb-2', 'LOE'), h('th', 'pb-2', 'Title'), h('th', 'pb-2', 'Status'), h('th', 'pb-2 text-right', 'Score')
                            ])),
                            h('tbody', 'text-gray-300 divide-y divide-gray-800', myArtifacts.map(a => h('tr', '', [
                                h('td', 'py-3', h('span', 'bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded', a.loe)),
                                h('td', '', a.title),
                                h('td', '', renderBadge(a.status, a.score)),
                                h('td', 'text-right font-mono', a.score > -1 ? a.score : '-')
                            ])))
                        ])
                    ], 'lg:col-span-2'),

                    // Contact Card (1/3 width)
                    renderCard([
                        h('h3', 'text-lg font-bold text-purple-400 mb-4', 'Squadron Contact'),
                        h('div', 'space-y-4', [
                            h('div', '', [
                                h('div', 'text-xs text-gray-500 uppercase tracking-wider', 'Unit Leader'),
                                h('div', 'text-white font-medium', 'Maj. C. Davis')
                            ]),
                            h('div', '', [
                                h('div', 'text-xs text-gray-500 uppercase tracking-wider', 'Unit'),
                                h('div', 'text-white font-medium', cadet.unit)
                            ]),
                            h('button', 'w-full text-center p-3 rounded-lg bg-purple-700 hover:bg-purple-600 text-white font-semibold flex items-center justify-center', [
                                renderIcon(Icons.ChevronRight, 18, 'mr-2'), 'Request Status Update'
                            ])
                        ])
                    ], 'bg-gradient-to-br from-gray-800 to-gray-900')
                ])
            ]);
            return content;
        };


        // --- MAIN APP LOGIC ---

        const renderApp = () => {
            const mainContent = document.getElementById('main-content');
            const roleContainer = document.getElementById('current-role-info');
            // Removed unused variable 'mobileMenu'

            // 1. Render Main View
            mainContent.innerHTML = '';
            let viewElement;
            switch (currentUser.role) {
                case 'HQ': viewElement = renderHQView(); break;
                case 'Cadet': viewElement = renderCadetView(); break;
                case 'Regional': viewElement = renderRegionalView(); break;
                case 'Squadron': viewElement = renderSquadronView(); break;
                case 'Parent': viewElement = renderParentView(); break;
                default: viewElement = h('div', 'text-white p-4', 'Role not found');
            }
            mainContent.appendChild(viewElement);

            // 2. Update Header
            document.getElementById('header-title').textContent = `${currentUser.role} Dashboard`;

            // 3. Update Sidebar Profile
            roleContainer.innerHTML = '';
            roleContainer.appendChild(h('div', 'flex items-center space-x-3', [
                h('div', 'w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-sm font-bold', currentUser.name.charAt(0)),
                h('div', '', [
                    h('div', 'text-sm font-medium text-white', currentUser.name),
                    h('div', 'text-xs text-gray-500', `${currentUser.role} Access`)
                ])
            ]));

            // 4. Update Sidebar Role Buttons
            const sidebarNav = document.getElementById('sidebar-nav');
            sidebarNav.innerHTML = '';
            USERS.forEach(user => {
                const isActive = currentUser.id === user.id;
                const button = h('button', `w-full flex items-center space-x-3 px-4 py-3 rounded-lg transition-colors ${isActive ? 'bg-purple-700 text-white' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`, [
                    renderIcon(Icons.UserCheck, 20, 'w-5 h-5'),
                    h('span', 'font-medium', `${user.role} View`)
                ]);
                button.addEventListener('click', () => {
                    currentUser = user;
                    mobileMenuOpen = false;
                    renderApp();
                    // Removed old app-container class toggle logic
                });
                sidebarNav.appendChild(button);
            });

            // 5. Update Mobile Menu State (CRITICAL FIX)
            const sidebar = document.getElementById('sidebar');
            if (sidebar) {
                sidebar.setAttribute('data-menu-state', mobileMenuOpen ? 'open' : 'closed');
            }
        };

        const setupEventListeners = () => {
            const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
            mobileMenuToggle.addEventListener('click', () => {
                mobileMenuOpen = !mobileMenuOpen;
                renderApp();
            });
        };

        // Initialize App on DOM load using DOMContentLoaded for better reliability and performance
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            renderApp();
        });

    </script>
</head>
<body class="bg-slate-950 text-gray-100 min-h-screen">
    <div id="app-container" class="h-screen overflow-hidden">
        
        <!-- Mobile Header -->
        <div class="lg:hidden flex items-center justify-between p-4 bg-gray-900 border-b border-gray-800">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 bg-purple-600 rounded-tr-lg rounded-bl-lg flex items-center justify-center font-bold">SF</div>
                <span class="font-bold tracking-wider">SFCC OPS</span>
            </div>
            <button id="mobile-menu-toggle">
                <!-- Icon will be replaced by JS logic based on state -->
                <svg id="mobile-menu-icon" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
        </div>

        <div class="flex h-full overflow-hidden">
            <!-- Sidebar: uses data-menu-state for mobile toggling, which is handled in CSS/JS -->
            <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-gray-900 border-r border-gray-800 transform transition-transform lg:translate-x-0 lg:static -translate-x-full" data-menu-state="closed">
                <div class="h-full flex flex-col">
                    <div class="p-6 flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-indigo-700 rounded-tr-xl rounded-bl-xl flex items-center justify-center shadow-lg shadow-purple-900/50">
                            <!-- Shield Icon placeholder -->
                            <svg class="text-white w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.618a8 8 0 10-11.234 11.234 8 8 0 0011.234-11.234z"></path></svg>
                        </div>
                        <div>
                            <h1 class="font-bold text-lg tracking-wider text-white leading-tight">SFCC<br/><span class="text-purple-400 text-xs font-normal uppercase">Command Suite</span></h1>
                        </div>
                    </div>

                    <nav id="sidebar-nav" class="flex-1 px-4 space-y-2 mt-4">
                        <div class="text-xs font-bold text-gray-600 uppercase tracking-widest mb-2 px-4">Role Simulator</div>
                        <!-- Role buttons rendered by JS -->
                    </nav>

                    <div class="p-4 border-t border-gray-800 bg-gray-900/50">
                        <div id="current-role-info" class="flex items-center space-x-3">
                            <!-- Current user info rendered by JS -->
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-slate-950 p-4 lg:p-8">
                <header class="flex justify-between items-center mb-8">
                    <div>
                        <h1 id="header-title" class="text-2xl lg:text-3xl font-bold text-white mb-1"></h1>
                        <p class="text-gray-400 text-sm flex items-center">
                             <!-- Lock Icon placeholder -->
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                            Secure Connection â€¢ Neutral Portfolio v2.4
                        </p>
                    </div>
                    <div class="hidden md:block">
                       <span class="bg-purple-900/30 text-purple-300 border border-purple-800 px-3 py-1 rounded-full text-xs font-mono">
                         Term: Fall 2023
                       </span>
                    </div>
                </header>

                <div id="main-content">
                    <!-- Content (HQ, Cadet, etc. View) is rendered here by JS -->
                </div>
            </main>
        </div>
    </div>
</body>
</html>
